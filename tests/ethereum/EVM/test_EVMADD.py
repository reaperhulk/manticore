from manticore.platforms import evm
from manticore.core.smtlib import ConstraintSet
import pytest


def make_evm_world():
    # Make the constraint store
    constraints = ConstraintSet()
    # make the ethereum world state
    world = evm.EVMWorld(constraints)
    return constraints, world


class TestEVM_ADD:
    def _execute(self, new_vm):
        last_returned = None
        last_exception = None
        try:
            new_vm.execute()
        except evm.Stop as e:
            last_exception = "STOP"
        except evm.NotEnoughGas:
            last_exception = "OOG"
        except evm.StackUnderflow:
            last_exception = "INSUFFICIENT STACK"
        except evm.InvalidOpcode:
            last_exception = "INVALID"
        except evm.SelfDestruct:
            last_exception = "SUICIDED"
        except evm.Return as e:
            last_exception = "RETURN"
            last_returned = e.data
        except evm.Revert:
            last_exception = "REVERT"

        return last_exception, last_returned

    @pytest.mark.parametrize(
        ("push_values", "stack_value"),
        [
            (
                [
                    115792089237316195423570985008687907853269984665640564039457584007913129639935,
                    115792089237316195423570985008687907853269984665640564039457584007913129639935,
                ],
                [115792089237316195423570985008687907853269984665640564039457584007913129639934],
            ),
            (
                [115792089237316195423570985008687907853269984665640564039457584007913129639935, 0],
                [115792089237316195423570985008687907853269984665640564039457584007913129639935],
            ),
            (
                [115792089237316195423570985008687907853269984665640564039457584007913129639935, 1],
                [0],
            ),
            (
                [115792089237316195423570985008687907853269984665640564039457584007913129639935, 1],
                [0],
            ),
            (
                [
                    115792089237316195423570985008687907853269984665640564039457584007913129639935,
                    57896044618658097711785492504343953926634992332820282019728792003956564819952,
                ],
                [57896044618658097711785492504343953926634992332820282019728792003956564819951],
            ),
            (
                [
                    115792089237316195423570985008687907853269984665640564039457584007913129639935,
                    3618502788666131106986593281521497120414687020801267626233049500247285301263,
                ],
                [3618502788666131106986593281521497120414687020801267626233049500247285301262],
            ),
            (
                [
                    115792089237316195423570985008687907853269984665640564039457584007913129639935,
                    16,
                ],
                [15],
            ),
            (
                [
                    115792089237316195423570985008687907853269984665640564039457584007913129639935,
                    32,
                ],
                [31],
            ),
            (
                [
                    115792089237316195423570985008687907853269984665640564039457584007913129639935,
                    48,
                ],
                [47],
            ),
            (
                [
                    115792089237316195423570985008687907853269984665640564039457584007913129639935,
                    6089590155545428825848686802984512581899718912,
                ],
                [6089590155545428825848686802984512581899718911],
            ),
            (
                [0, 115792089237316195423570985008687907853269984665640564039457584007913129639935],
                [115792089237316195423570985008687907853269984665640564039457584007913129639935],
            ),
            ([0, 0], [0]),
            ([0, 1], [1]),
            (
                [0, 57896044618658097711785492504343953926634992332820282019728792003956564819952],
                [57896044618658097711785492504343953926634992332820282019728792003956564819952],
            ),
            (
                [0, 3618502788666131106986593281521497120414687020801267626233049500247285301263],
                [3618502788666131106986593281521497120414687020801267626233049500247285301263],
            ),
            ([0, 16], [16]),
            ([0, 32], [32]),
            ([0, 48], [48]),
            (
                [0, 6089590155545428825848686802984512581899718912],
                [6089590155545428825848686802984512581899718912],
            ),
            (
                [1, 115792089237316195423570985008687907853269984665640564039457584007913129639935],
                [0],
            ),
            ([1, 0], [1]),
            ([1, 1], [2]),
            (
                [1, 57896044618658097711785492504343953926634992332820282019728792003956564819952],
                [57896044618658097711785492504343953926634992332820282019728792003956564819953],
            ),
            (
                [1, 3618502788666131106986593281521497120414687020801267626233049500247285301263],
                [3618502788666131106986593281521497120414687020801267626233049500247285301264],
            ),
            ([1, 16], [17]),
            ([1, 32], [33]),
            ([1, 48], [49]),
            (
                [1, 6089590155545428825848686802984512581899718912],
                [6089590155545428825848686802984512581899718913],
            ),
            (
                [
                    57896044618658097711785492504343953926634992332820282019728792003956564819952,
                    115792089237316195423570985008687907853269984665640564039457584007913129639935,
                ],
                [57896044618658097711785492504343953926634992332820282019728792003956564819951],
            ),
            (
                [57896044618658097711785492504343953926634992332820282019728792003956564819952, 0],
                [57896044618658097711785492504343953926634992332820282019728792003956564819952],
            ),
            (
                [57896044618658097711785492504343953926634992332820282019728792003956564819952, 1],
                [57896044618658097711785492504343953926634992332820282019728792003956564819953],
            ),
            (
                [
                    57896044618658097711785492504343953926634992332820282019728792003956564819952,
                    57896044618658097711785492504343953926634992332820282019728792003956564819952,
                ],
                [115792089237316195423570985008687907853269984665640564039457584007913129639904],
            ),
            (
                [
                    57896044618658097711785492504343953926634992332820282019728792003956564819952,
                    3618502788666131106986593281521497120414687020801267626233049500247285301263,
                ],
                [61514547407324228818772085785865451047049679353621549645961841504203850121215],
            ),
            (
                [57896044618658097711785492504343953926634992332820282019728792003956564819952, 16],
                [57896044618658097711785492504343953926634992332820282019728792003956564819968],
            ),
            (
                [57896044618658097711785492504343953926634992332820282019728792003956564819952, 32],
                [57896044618658097711785492504343953926634992332820282019728792003956564819984],
            ),
            (
                [57896044618658097711785492504343953926634992332820282019728792003956564819952, 48],
                [57896044618658097711785492504343953926634992332820282019728792003956564820000],
            ),
            (
                [
                    57896044618658097711785492504343953926634992332820282019728792003956564819952,
                    6089590155545428825848686802984512581899718912,
                ],
                [57896044618658097711785492504350043516790537761646130706531776516538464538864],
            ),
            (
                [
                    3618502788666131106986593281521497120414687020801267626233049500247285301263,
                    115792089237316195423570985008687907853269984665640564039457584007913129639935,
                ],
                [3618502788666131106986593281521497120414687020801267626233049500247285301262],
            ),
            (
                [3618502788666131106986593281521497120414687020801267626233049500247285301263, 0],
                [3618502788666131106986593281521497120414687020801267626233049500247285301263],
            ),
            (
                [3618502788666131106986593281521497120414687020801267626233049500247285301263, 1],
                [3618502788666131106986593281521497120414687020801267626233049500247285301264],
            ),
            (
                [
                    3618502788666131106986593281521497120414687020801267626233049500247285301263,
                    57896044618658097711785492504343953926634992332820282019728792003956564819952,
                ],
                [61514547407324228818772085785865451047049679353621549645961841504203850121215],
            ),
            (
                [
                    3618502788666131106986593281521497120414687020801267626233049500247285301263,
                    3618502788666131106986593281521497120414687020801267626233049500247285301263,
                ],
                [7237005577332262213973186563042994240829374041602535252466099000494570602526],
            ),
            (
                [3618502788666131106986593281521497120414687020801267626233049500247285301263, 16],
                [3618502788666131106986593281521497120414687020801267626233049500247285301279],
            ),
            (
                [3618502788666131106986593281521497120414687020801267626233049500247285301263, 32],
                [3618502788666131106986593281521497120414687020801267626233049500247285301295],
            ),
            (
                [3618502788666131106986593281521497120414687020801267626233049500247285301263, 48],
                [3618502788666131106986593281521497120414687020801267626233049500247285301311],
            ),
            (
                [
                    3618502788666131106986593281521497120414687020801267626233049500247285301263,
                    6089590155545428825848686802984512581899718912,
                ],
                [3618502788666131106986593281527586710570232449627116313036034012829185020175],
            ),
            (
                [
                    16,
                    115792089237316195423570985008687907853269984665640564039457584007913129639935,
                ],
                [15],
            ),
            ([16, 0], [16]),
            ([16, 1], [17]),
            (
                [16, 57896044618658097711785492504343953926634992332820282019728792003956564819952],
                [57896044618658097711785492504343953926634992332820282019728792003956564819968],
            ),
            (
                [16, 3618502788666131106986593281521497120414687020801267626233049500247285301263],
                [3618502788666131106986593281521497120414687020801267626233049500247285301279],
            ),
            ([16, 16], [32]),
            ([16, 32], [48]),
            ([16, 48], [64]),
            (
                [16, 6089590155545428825848686802984512581899718912],
                [6089590155545428825848686802984512581899718928],
            ),
            (
                [
                    32,
                    115792089237316195423570985008687907853269984665640564039457584007913129639935,
                ],
                [31],
            ),
            ([32, 0], [32]),
            ([32, 1], [33]),
            (
                [32, 57896044618658097711785492504343953926634992332820282019728792003956564819952],
                [57896044618658097711785492504343953926634992332820282019728792003956564819984],
            ),
            (
                [32, 3618502788666131106986593281521497120414687020801267626233049500247285301263],
                [3618502788666131106986593281521497120414687020801267626233049500247285301295],
            ),
            ([32, 16], [48]),
            ([32, 32], [64]),
            ([32, 48], [80]),
            (
                [32, 6089590155545428825848686802984512581899718912],
                [6089590155545428825848686802984512581899718944],
            ),
            (
                [
                    48,
                    115792089237316195423570985008687907853269984665640564039457584007913129639935,
                ],
                [47],
            ),
            ([48, 0], [48]),
            ([48, 1], [49]),
            (
                [48, 57896044618658097711785492504343953926634992332820282019728792003956564819952],
                [57896044618658097711785492504343953926634992332820282019728792003956564820000],
            ),
            (
                [48, 3618502788666131106986593281521497120414687020801267626233049500247285301263],
                [3618502788666131106986593281521497120414687020801267626233049500247285301311],
            ),
            ([48, 16], [64]),
            ([48, 32], [80]),
            ([48, 48], [96]),
            (
                [48, 6089590155545428825848686802984512581899718912],
                [6089590155545428825848686802984512581899718960],
            ),
            (
                [
                    6089590155545428825848686802984512581899718912,
                    115792089237316195423570985008687907853269984665640564039457584007913129639935,
                ],
                [6089590155545428825848686802984512581899718911],
            ),
            (
                [6089590155545428825848686802984512581899718912, 0],
                [6089590155545428825848686802984512581899718912],
            ),
            (
                [6089590155545428825848686802984512581899718912, 1],
                [6089590155545428825848686802984512581899718913],
            ),
            (
                [
                    6089590155545428825848686802984512581899718912,
                    57896044618658097711785492504343953926634992332820282019728792003956564819952,
                ],
                [57896044618658097711785492504350043516790537761646130706531776516538464538864],
            ),
            (
                [
                    6089590155545428825848686802984512581899718912,
                    3618502788666131106986593281521497120414687020801267626233049500247285301263,
                ],
                [3618502788666131106986593281527586710570232449627116313036034012829185020175],
            ),
            (
                [6089590155545428825848686802984512581899718912, 16],
                [6089590155545428825848686802984512581899718928],
            ),
            (
                [6089590155545428825848686802984512581899718912, 32],
                [6089590155545428825848686802984512581899718944],
            ),
            (
                [6089590155545428825848686802984512581899718912, 48],
                [6089590155545428825848686802984512581899718960],
            ),
            (
                [
                    6089590155545428825848686802984512581899718912,
                    6089590155545428825848686802984512581899718912,
                ],
                [12179180311090857651697373605969025163799437824],
            ),
        ],
    )
    def test_ADD(self, push_values, stack_value):
        constraints, world = make_evm_world()
        bytecode = b"\x01"
        address = 0x222222222222222222222222222222222222200
        caller = origin = 0x111111111111111111111111111111111111100
        price = 0
        value = 10000
        data = "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAA"
        gas = 1000000

        new_vm = evm.EVM(constraints, address, data, caller, value, bytecode, gas=gas, world=world)
        for val in push_values:
            new_vm._push(val)
        last_exception, last_returned = self._execute(new_vm)
        assert last_exception is None
        assert new_vm.pc == 1
        assert new_vm.stack == stack_value
